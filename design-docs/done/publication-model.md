## Customising Ivy descriptor XML (DONE)

This initial step will provide some capability to modify the generated `ivy.xml` files before publication. It will introduce a new set of tasks for publishing
to repositories.

1. Introduce a `Publication` interface. Probably make `Publication` a `Named` thing.
2. Add a `Publication` container to the project. At this stage, this container will be _read-only_.
3. Add `IvyPublication` interface and `IvyModuleDescriptor` interface.
    * Has-a property called `descriptor` of type `IvyModuleDescriptor`.
4. Add an `ivy-publish` plugin that adds a single `IvyPublication` instance to the container.
5. When using this `IvyPublication` for publishing, the following defaults are used:
    * `organisation` == `project.group`
    * `module` == `project.name` (_not_ `archivesBaseName`)
    * `revision` == `project.version`
    * `status` == `project.status`
    * Only dependency declarations from public configurations are included, and no configuration extension is used.
    * All artifacts from public configurations are published.
6. Add an `IvyPublish` task type.
    * Has-a property called `publication` of type `IvyPublication`
    * Has-a property called `repository` of type `IvyArtifactRepository`
7. When the `ivy-publish` plugin is applied, a rule is added that will add a `publish${publication.name}` task of type `Publish` for each publicaton
   added to the publications container.
    * The `publication` property will be wired up to the publication
    * The `repository` property will be left unspecified.
8. When the `ivy-publish` plugin is applied, a lifecycle task called `publish` is added that dependsOn those tasks added by the above rule.
9. Add `IvyModuleDescriptor.withXml()` methods and wire this up to `ivy.xml` generation.

TBD - Add a `publishing` extension with repositories and publications

To publish an Ivy module:

    apply plugin: 'ivy-publish'

    publishing {
        repositories {
            ivy { ... }
        }
    }

Running `gradle publish` will build the artifacts and upload to the specified repository.

To customise the `ivy.xml`:

    apply plugin: 'ivy-publish'

    publishing {
        repositories.ivy { ... }

        publications.ivy.descriptor.withXml { xml -> ... }
    }

Another example, using rules:

    apply plugin: 'ivy-publish'

    publishing {
        repositories.ivy { ... }

        publications.withType(IvyPublication) {
            ivy.withXml { xml -> ... }
        }
    }

To publish to multiple repositories:

    apply plugin: 'ivy-publish'

    publishing {
        repositories {
            ivy { ... }
            ivy { ... }
        }
    }

Running `gradle publish` will publish the module to both repositories.

The `ivy-publish` plugin is intended to move Ivy concepts out of the core Gradle DSL, but still allow them to be available for customisation for those
projects that use Ivy. It also allows us to introduce some breaking changes, in an opt-in way.

Note: there are some breaking changes here when you apply the `ivy-publish` plugin:

* The project name rather than the `archivesBaseName` property is  used as the default Ivy module name.
* Only the dependency declarations and artifacts from public configurations are referenced in the generated Ivy descriptor and published to the
      repository.

Note that publishing multiple Ivy modules is not yet supported. This is covered by later stories.

### Implementation approach

The `IvyPublication` instance will need to be considered by `IvyBackedArtifactPublisher` when generating the Ivy descriptor. It might make sense
at this point to start pulling descriptor generation up, so that it can eventually be generated by a task.

### Test cases

* Basic test that running the `publish` task actually publishes something.
    * With java plugin
    * With no other plugins
* Multi-project build with project dependencies that is published to an Ivy repository can be successfully resolved by another build.
* A `withXml` action can be used to modify the generated `ivy.xml`.
* Decent error message when the `withXml` action fails.
* Descriptor contains non-ascii characters.

## Customising Maven descriptor XML (DONE)

This step will provide some capability to modify the generated `pom.xml` files before publication. It will introduce the ability to use the new
publication tasks to publish Maven modules.

1. Add `MavenPublication` interface and `MavenPom` interface.
    * A `MavenPublication` has-a property called `pom` of type `MavenPom`.
2. Add a `maven-publish` plugin. This plugin adds a single `MavenPublication` instance.
3. When this `MavenPublication` instance is used for publishing, the following defaults are used:
    * `groupId` == `project.group`
    * `artifactId` == `project.name` (_not_ `archivesBaseName`)
    * `version` == `project.version`
    * `packaging` == `null`
    * No dependencies are included in the pom.
    * All artifacts from public configurations are published.
4. Add a `PublishToMavenRepository` task.
5. Change the `maven` repository type to handle publishing a `MavenPublication`.
6. Add `Pom.withXml()` methods and wire these up to pom generation.
7. When the `maven-publish` plugin is applied, a rule is added to define a `PublishToMavenRepository` task instance for each `MavenPublication` and each publishing repository of
   type `MavenRepository`.
8. When the `maven-publish` plugin is applied, a rule is added to define a `publishLocal${publication.name}` task of type `MavenPublish` for each publication
   of type `MavenPublication` added to the publications container.
    * The `publication` property is wired up to the publication
    * The `repository` property defaults to `mavenLocal()`.
9. Update the "Ivy Publishing" chapter in the user guide to also describe how to publish to a Maven repository.

To publish a Maven module:

    apply plugin: 'maven-publish'

    repositories {
        maven { ... }
    }

Running `gradle publish` will build the artifacts and upload to the specified repository. Running `gradle publishMavenLocal` will build the artifacts and
copy them into the local Maven repository.

To customise the `pom.xml`:

    apply plugin: 'maven-publish'

    publishing {
        repositories.maven { ... }

        publications.maven.pom.withXml { xml -> ... }
    }

Or, using rules:

    apply plugin: 'maven-publish'

    publishing {
        repositories.maven { ... }

        publications.withType(MavenPublication) {
            pom.withXml { xml -> ... }
        }
    }

Publishing both an Ivy and Maven module:

    apply plugin: 'ivy-publish'
    apply plugin: 'maven-publish'

    publishing {
        repositories {
            ivy { ... }
            maven { ... }
        }
    }

Running `gradle publish` will build and upload both modules.

Note: there are some breaking changes here when you apply the `maven-publish` plugin:

* The project name rather than `archivesBaseName` property is used as the default Maven module artifactId.
* No dependencies are included in the generated `pom.xml`.
* Only artifacts from public configurations are included the publication.

Note that publishing multiple Maven modules is not yet supported. It is also not possible to add any dependencies to the pom (except via manipulating
the XML). These are covered by later stories.

### Implementation approach

It should be possible to implement this as an adapter over the existing MavenPom/MavenResolver infrastructure.

### Test cases

* Basic test that running the `publish` task publishes artifacts and the pom.
* A `withXml` action can be used to modify the generated `pom.xml`.
* Decent error message when the `withXml` action fails.
* Descriptor contains non-ascii characters.

## Allow Ivy module descriptor to be generated without publishing to a repository (DONE)

In this step, the meta-data file generation for an Ivy publication is moved out of the `publish` tasks and into a separate task.

1. Add `GenerateIvyDescriptor` task type. Takes a `IvyModuleDescriptor` as input and generates an `ivy.xml` from this.
2. The `ivy-publish` task adds a rule to define a `generate${publication}MetaData` task for each publication of type `IvyPublication` added to the
   publications container.
3. Remove the `file` property from `IvyModuleDescriptor`, and replace it with a `descriptorFile` property on `IvyPublication`.
4. Change `IvyModuleDescriptor` so that it no longer extends `Buildable`.
5. Change the `GenerateIvyDescriptor` task type to remove the `module` and `configurations` properties, and replace these with a `descriptor` property of
   type `IvyModuleDescriptor`.
6. Update user guide to mention how to generate the `ivy.xml` for a publication.

To generate the Ivy module descriptor:

    apply plugin: 'ivy-publish`

Running `gradle generateIvyMetaData` would generate the `ivy.xml` for the default Ivy publication for this project.

### Test cases

* Unignore IvyLocalPublishIntTest.canGenerateTheIvyXmlWithoutPublishing().
