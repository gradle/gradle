name: Code Scanning ğŸ”
on:
  push:
    branches: [ main, master, release ]
  schedule:
    - cron: '0 5 * * *'
jobs:
  codeql-build:
    name: CodeQL Build ğŸ—ï¸
    permissions:
      actions: read #           for github/codeql-action/init to get workflow details
      contents: read #          for actions/checkout to fetch code
      security-events: write #  for github/codeql-action/analyze to upload SARIF results
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ['java', 'javascript'] # Override automatic language detection by changing the below list; Supported options are ['csharp', 'cpp', 'go', 'java', 'javascript', 'python']
        # Learn more...
        # https://docs.github.com/en/github/finding-security-vulnerabilities-and-errors-in-your-code/configuring-code-scanning#overriding-automatic-language-detection
    steps:
      - name: Checkout Repository ğŸ“¥ # Checkout must run before the caching key is computed using the `hashFiles` method.
        uses: actions/checkout@v6
      - name: Cache Gradle Modules ğŸ—‚ï¸
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches/modules-2/
            ~/.gradle/caches/build-cache-1/
            ~/.gradle/caches/signatures/
            ~/.gradle/caches/keyrings/
          key: ${{ runner.os }}-gradle-cache-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
          if: ${{ matrix.language == 'java' }}
      - name: Disable Checksum Offloading âš¡ï¸
        run: sudo ethtool -K eth0 tx off rx off # See: https://github.com/actions/virtual-environments/issues/1187#issuecomment-686735760
      - name: Setup JDK 17 â˜•ï¸
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17
      - name: Initialize CodeQL ğŸ›¡ï¸
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          tools: latest
      - name: Compile with Gradle (Build Scan) ğŸ˜
        if: ${{ matrix.language == 'java' && github.repository_owner == 'gradle' }}
        run: ./gradlew --init-script .github/workflows/codeql-analysis.init.gradle -Ddevelocity.edge.discovery=false -DcacheNode=us -S testClasses -Dhttp.keepAlive=false
        env:
          DEVELOCITY_ACCESS_KEY: ${{ secrets.DEVELOCITY_ACCESS_KEY }} # Set the DEVELOCITY_ACCESS_KEY so that a Build Scan is generated
          GRADLE_OPTS: -Dhttp.keepAlive=false # Potential stop-gap solution for ReadTimeout issues with the Gradle Build Cache # https://gradle.slack.com/archives/CHDLT99C6/p1636477584059200
      - name: Compile with Gradle (No Build Scan) ğŸ”¨
        if: ${{ matrix.language == 'java' && github.repository_owner != 'gradle' }}
        run: ./gradlew --init-script .github/workflows/codeql-analysis.init.gradle -S testClasses
      - name: Cleanup Gradle Daemons ğŸ§¹
        run: ./gradlew --stop
        if: ${{ matrix.language == 'java' }}
      # â„¹ï¸ Command-line programs to run using the OS shell.
      # ğŸ“š https://git.io/JvXDl
      # âœï¸ If the Autobuild fails above, remove it and uncomment the following three lines
      #    and modify them (or add more) to build your code if your project
      #    uses a compiled language
      # - run: |
      #   make bootstrap
      #   make release
      - name: Perform CodeQL Analysis ğŸ”
        uses: github/codeql-action/analyze@v4
        with:
          config-file: ./.github/codeql/codeql-config.yml
      - name: Cleanup Gradle Cache ğŸ—‘ï¸ # Cleans up the Gradle caches before being cached
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties
        if: ${{ matrix.language == 'java' }}
