// Copyright 2023 the original author or authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

[[build_lifecycle]]
= Build Lifecycle

Gradle is an example of *dependency based programming*: you define tasks and dependencies between tasks.

Gradle guarantees that these tasks will execute in order of their dependencies.
Your build scripts and plugins configure this dependency graph.

There are phases of the lifecycle Gradle passes through as it interprets those scripts.

== Task Graphs

Unlike other build tools, Gradle builds the task graph *before* executing any task.

With *configuration avoidance*, Gradle skips configuration for tasks that aren't part of the current build.

Within each project, tasks form a http://en.wikipedia.org/wiki/Directed_acyclic_graph[Directed Acyclic Graph] (DAG).

This diagram shows two example task graphs, one abstract and the other concrete with dependencies between tasks represented as arrows:

image::task-dag-examples.png[]

[[build_lifecycle_events]]
Both plugins and build scripts contribute to the task graph via the <<tutorial_using_tasks#sec:task_dependencies,task dependency mechanism>>.

[[sec:build_phases]]
== Build Phases

A Gradle build has three distinct phases.

Gradle runs these phases in order:

PHASE 1. Initialization::
- Detects the `settings.gradle.kts` file.
- Creates a link:{groovyDslPath}/org.gradle.api.initialization.Settings.html[`Settings`] instance.
- Evaluates the settings file to determine which projects (and included builds) make up the build.
- Creates a link:{groovyDslPath}/org.gradle.api.Project.html[`Project`] instance for every project.
PHASE 2. Configuration::
- Evaluates the build scripts (`build.gradle.kts`) of every project participating in the build.
- Creates a task graph for requested tasks.
PHASE 3. Execution::
- Schedules and executes each of the selected tasks in order of their dependencies.

image::build-lifecycle-example.png[]

=== Example

The following example shows which parts of settings and build files correspond to various build phases:

====
include::sample[dir="snippets/buildlifecycle/basic/kotlin",files="settings.gradle.kts[];build.gradle.kts[]"]
include::sample[dir="snippets/buildlifecycle/basic/groovy",files="settings.gradle[];build.gradle[]"]
====

The following command configures and executes the `test` and `testBoth` tasks specified above.
Because Gradle only configures requested tasks and their dependencies, the `configured` task never configures:

[source.multi-language-sample,kotlin]
----
> gradle test testBoth
include::{snippetsPath}/buildlifecycle/basic/tests/buildlifecycle.out[]
----
[source.multi-language-sample,groovy]
----
> gradle test testBoth
include::{snippetsPath}/buildlifecycle/basic/tests/buildlifecycle.out[]
----

[[sec:initialization]]
== Phase 1. Initialization

In the *initialization phase*, Gradle detects the set of projects (root project and subprojects) and included builds participating in the build.

Gradle first evaluates the settings file (`settings.gradle.kts`) and instantiates a `Settings` object.
Then, Gradle instantiates `Project` instances for each project.

=== Detect Settings File

When you run Gradle in a directory that contains a `settings.gradle` file, Gradle uses that `settings.gradle` file to initialize the build using a link:{groovyDslPath}/org.gradle.api.initialization.Settings.html[`Settings`] object.

You can run Gradle within any subproject of the build.footnote:[Gradle supports partial multi-project builds (see <<intro_multi_project_builds.adoc#intro_multi_project_builds,Executing Multi-Project Builds>>).]

When you run Gradle in a directory that contains *no* `settings.gradle` file:

. Gradle looks for a `settings.gradle(.kts)` file in parent directories.
. If Gradle finds a `settings.gradle(.kts)` file, Gradle checks if the current project is part of the multi-project build. If so, Gradle builds as a multi-project.
. If Gradle does not find a `settings.gradle(.kts)` file, Gradle builds as a single project.

In a standard Gradle project, <<intro_multi_project_builds#sec:project_path,project paths>> match the physical subproject layout on disk.

The automatic search for a settings file only works for multi-project builds with a standard project layout.
To build projects that use a nonstandard layout, execute the build from the directory that contains the `settings.gradle(.kts)` file.

=== Evaluate Settings File

During settings file evaluation, Gradle:

- Instantiates a link:{groovyDslPath}/org.gradle.api.initialization.Settings.html[`Settings`] object.
- Adds libraries to your build script classpath.
- Defines which included builds participate in a composite build.
- Defines which projects participate in a multi-project build.

Gradle creates a link:{groovyDslPath}/org.gradle.api.Project.html[`Project`] for every project in the build.
By default, each `Project` has a name equal to the name of its top level directory.
Every project except the root project has a parent project.
Any project may have child projects.

[[sec:configuration]]
== Phase 2. Configuration

In the *configuration phase*, Gradle adds tasks and other properties to the projects generated by the initialization phase.

By the end of the configuration phase, Gradle has a complete task execution graph for the requested tasks.

[[sec:project_evaluation]]
=== Project Evaluation

During project evaluation, Gradle evaluates build scripts (`build.gradle.kts`) to build a task hierarchy within a `Project`.
This hierarchy includes inputs, actions, and outputs for all tasks.

=== Task Execution Graph Assembly

During project evaluation, Gradle assembles the *task execution graph*: a http://en.wikipedia.org/wiki/Directed_acyclic_graph[DAG] representing the dependency relationships between tasks.

=== Task Creation

During project evaluation, Gradle registers tasks and their configuration actions. The configuration actions define inputs, outputs, and actions for those tasks.
They are evaluated if the task is part of the task graph for the requested tasks.

[[sec:execution]]
== Phase 3. Execution

In the *execution phase*, Gradle runs tasks.

Gradle uses the task execution graphs generated by the configuration phase to determine which tasks to execute.

[[sec:task_execution]]
=== Task Execution

Task execution includes most of the work you normally associate with a build: downloading libraries, compiling code, reading inputs, and writing outputs.
